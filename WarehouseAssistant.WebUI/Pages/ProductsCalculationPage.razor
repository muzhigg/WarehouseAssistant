@page "/order/products"
@using WarehouseAssistant.Core.Models
@using WarehouseAssistant.Data.Models
@using WarehouseAssistant.WebUI.Components

<DataGrid T="ProductTableItem" Items="_products" LocalStorageKey="bglc_order" @ref="_dataGrid" LoadingProgressColor="Color.Primary"
          FixedHeader="true" Hover="true" Bordered="true" Striped="true" Height="80vh" ColumnResizeMode="ResizeMode.Column" ShowColumnOptions="false"
          Filterable="true" QuickFilter="@ShouldDisplayProduct" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
          MultiSelection="true"                                                                                                          
          EditMode="DataGridEditMode.Cell" EditTrigger="DataGridEditTrigger.OnRowClick" CommittedItemChanges="OnQuantityToOrderCommittedChanges" ReadOnly="false">
    <ToolBarContent>    
        <MudButton Class="open-upload-table-dialog-button" hidden="@_products.Any()" Disabled="_dataGrid.Loading" Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowFileUploadDialog" StartIcon="@Icons.Material.Filled.TableView">Загрузить таблицу</MudButton>  
        <MudButton Class="open-calculation-dialog-button" hidden="@(!_products.Any())" Disabled="_dataGrid.Loading" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Calculate">Расчитать выбранные</MudButton>
        <MudSpacer/>
        <MudTextField T="string" Disabled="_dataGrid.Loading" @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0">
        </MudTextField>
    </ToolBarContent>
    <Columns>                          
        <HierarchyColumn T="ProductTableItem"></HierarchyColumn>
        <SelectColumn T="ProductTableItem" />
        <PropertyColumn Property="x => x.Name" Title="Название" Sortable="false" Resizable="false" IsEditable="false" />
        <PropertyColumn Property="x => x.Article" Title="Артикул" Sortable="false" Resizable="false" IsEditable="false"/>
        <PropertyColumn Property="x => x.AvailableQuantity" Title="Доступное количество на БГЛЦ" Sortable="false" Resizable="false" IsEditable="false"/>
        <PropertyColumn Property="x => x.CurrentQuantity" Title="Текущее количество в СПб" Sortable="false" Resizable="false"  IsEditable="false"/>
        <PropertyColumn Property="x => x.AverageTurnover" Title="Средняя оборачиваемость в день" Resizable="false" IsEditable="false"/>
        <PropertyColumn Property="x => x.StockDays" Title="Запас на количество дней" Resizable="false" IsEditable="false"/>
        <PropertyColumn Property="x => x.OrderCalculation" Title="Рекомендованное количество" Resizable="false" IsEditable="false"/>
        <PropertyColumn Property="x => x.QuantityToOrder" Title="Количество для заказа" Filterable="false" Resizable="false" IsEditable="true"/>
    </Columns>    
    <ChildRowContent>   
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@context.Item.Name</MudText>        
                </CardHeaderContent>
            </MudCardHeader>           
            <MudCardContent>
                @if (_dbProducts == null || !_dbProducts.Exists(product => product.Article == context.Item.Article))
                {
                    <MudText>Товар не найден в базе данных</MudText>
                    <MudButton Variant="Variant.Filled" OnClick="() => ShowAddToDbDialog(context.Item)">Добавить в БД</MudButton>
                }
                else
                {
                    Product dbItem = _dbProducts.Find(product => product.Article == context.Item.Article)!;
                    <MudText>@dbItem.Name</MudText>
                    <MudText>@("Артикул: " + dbItem.Article)</MudText>
                    <MudText>@("Штрих-код: " + @dbItem.Barcode)</MudText>
                    <MudText>@("Количество на коробку: " + @dbItem.QuantityPerBox)</MudText>
                    <MudText>@("Количество на полку: " + @dbItem.QuantityPerShelf)</MudText>
                }
            </MudCardContent>
        </MudCard>

    </ChildRowContent>
    <PagerContent>
        <MudDataGridPager Disabled="_dataGrid.Loading" T="ProductTableItem" PageSizeOptions="new[] { 10, 25, 50, 100 }" RowsPerPageString="Количество на странице" />
    </PagerContent>
</DataGrid>